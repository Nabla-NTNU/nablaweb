{% extends "base.html"%}

{% block main %}
  <h1>hei</h1>
  <script src="https://unpkg.com/vue@next"></script>
  <script src="https://unpkg.com/axios/dist/axios.js"></script>
  <!-- <script src="https://unpkg.com/vue@3.2.26/dist/vue.global.prod.js"></script> -->
  <!-- <script src="https://unpkg.com/axios@0.24.0/dist/axios.min.js"></script> -->
  <div id="attendance-app" >
  </div>
  <template id="AttendanceAppTemplate">
    <form @submit.prevent="submitForm">
      <input type="text" placeholder="Enter card number" v-model="textField">
    </form>
    <span v-if="this.error==null">
      [[ this.lastUser ]] checked [[ this.lastUserInOut ? "in" : "out"]]
    </span>
    <span v-else>Not ok. Error: [[ this.error ]]</span>
    <user-item
      v-for="user in users"
      v-bind:user="user"
    ></user-item>
  </template>
  <script>
   const UserItem = {
     delimiters: ['[[', ']]'],
     props: ['user'],
     template: '<div><span @click="checkOutUser" class="fas fa-times-circle"></span> [[ user ]]</div>',
     methods: {
       checkOutUser() {
         if(!confirm("Do you really want to check out " + this.user + "?")) return
         axios
		     .get("/stem/admin/1/api/attendance/username/" + this.user + "?action=out")
		     .then(response => {
		       this.$parent.users = response.data.currently_checked_in
		     })
       }
     }
   }

   const AttendanceApp = {
     delimiters: ['[[', ']]'],
     components: {UserItem},
     data() {
	     return {
	       textField: null,  // Input, either card, username, ...
	       users: null,  // Currently checked in users
	       lastUser: null,  // The last user to check in/out
	       lastUserInOut: null,  // Whether the last user checked in or out
	       error: null,  // Current errors
	     }
     },
     template: "#AttendanceAppTemplate",
     mounted: function() {
	     axios
		     .get("/stem/admin/1/api/attendance/username/" + this.textField + "?action=nothing")
		     .then(response => {
           console.log(response.data)
		       this.users = response.data.currently_checked_in
		     })
     },
     methods: {
	     submitForm() {
	       axios
		       .get("/stem/admin/1/api/attendance/username/" + this.textField)
		       .then(response => {
		         this.users = response.data.currently_checked_in
		         this.lastUser = response.data.user
		         this.lastUserInOut = response.data.inout
		         this.error = response.data.reason
		       })
	     }
     }
   }

   const app = Vue.createApp(AttendanceApp)
   const vm = app.mount('#attendance-app')
  </script>
{% endblock main %}
